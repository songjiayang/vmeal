/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("image",function(e){var t=this,n="image",r=e.undef(t.allowImageUpload,!0),i=e.undef(t.formatUploadUrl,!0),s=e.undef(t.allowFileManager,!1),o=e.undef(t.uploadJson,t.basePath+"php/upload_json.php"),u=e.undef(t.imageTabIndex,0),a=t.pluginsPath+"image/images/",f=e.undef(t.extraFileUploadParams,{}),l=e.undef(t.filePostName,"imgFile"),c=e.undef(t.fillDescAfterUploadImage,!1),h=t.lang(n+".");t.plugin.imageDialog=function(r){function R(e,t){_.val(e),D.val(t),I=e,q=t}var u=r.imageUrl,p=e.undef(r.imageWidth,""),d=e.undef(r.imageHeight,""),v=e.undef(r.imageTitle,""),m=e.undef(r.imageAlign,""),g=e.undef(r.showRemote,!0),y=e.undef(r.showLocal,!0),b=e.undef(r.tabIndex,0),w=r.clickFn,E="kindeditor_upload_iframe_"+(new Date).getTime(),S=[];for(var x in f)S.push('<input type="hidden" name="'+x+'" value="'+f[x]+'" />');var T=['<div style="padding:20px;">','<div class="tabs"></div>','<div class="tab1" style="display:none;">','<div class="ke-dialog-row">','<label for="remoteUrl" style="width:60px;">'+h.remoteUrl+"</label>",'<input type="text" id="remoteUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+h.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="remoteWidth" style="width:60px;">'+h.size+"</label>",h.width+' <input type="text" id="remoteWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> ',h.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> ','<img class="ke-refresh-btn" src="'+a+'refresh.png" width="16" height="16" alt="" style="cursor:pointer;" title="'+h.resetSize+'" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+h.align+"</label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+a+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+a+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+a+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="remoteTitle" style="width:60px;">'+h.imgTitle+"</label>",'<input type="text" id="remoteTitle" class="ke-input-text" name="title" value="" style="width:200px;" />',"</div>","</div>",'<div class="tab2" style="display:none;">','<iframe name="'+E+'" style="display:none;"></iframe>','<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+E+'" action="'+e.addParam(o,"dir=image")+'">','<div class="ke-dialog-row">',S.join(""),'<label style="width:60px;">'+h.localUrl+"</label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+h.upload+'" />',"</div>","</form>","</div>","</div>"].join(""),N=y||s?450:400,C=y&&g?300:250,k=t.createDialog({name:n,width:N,height:C,title:t.lang(n),body:T,yesBtn:{name:t.lang("yes"),click:function(n){if(k.isLoading)return;if(y&&g&&j&&j.selectedIndex===1||!g){if(F.fileBox.val()==""){alert(t.lang("pleaseSelectFile"));return}k.showLoading(t.lang("uploadLoading")),F.submit(),O.val("");return}var r=e.trim(A.val()),i=_.val(),s=D.val(),o=H.val(),u="";B.each(function(){if(this.checked)return u=this.value,!1});if(r=="http://"||e.invalidUrl(r)){alert(t.lang("invalidUrl")),A[0].focus();return}if(!/^\d*$/.test(i)){alert(t.lang("invalidWidth")),_[0].focus();return}if(!/^\d*$/.test(s)){alert(t.lang("invalidHeight")),D[0].focus();return}w.call(t,r,o,i,s,0,u)}},beforeRemove:function(){M.unbind(),_.unbind(),D.unbind(),P.unbind()}}),L=k.div,A=e('[name="url"]',L),O=e('[name="localUrl"]',L),M=e('[name="viewServer"]',L),_=e('.tab1 [name="width"]',L),D=e('.tab1 [name="height"]',L),P=e(".ke-refresh-btn",L),H=e('.tab1 [name="title"]',L),B=e('.tab1 [name="align"]',L),j;g&&y?(j=e.tabs({src:e(".tabs",L),afterSelect:function(e){}}),j.add({title:h.remoteImage,panel:e(".tab1",L)}),j.add({title:h.localImage,panel:e(".tab2",L)}),j.select(b)):g?e(".tab1",L).show():y&&e(".tab2",L).show();var F=e.uploadbutton({button:e(".ke-upload-button",L)[0],fieldName:l,form:e(".ke-form",L),target:E,width:60,afterUpload:function(r){k.hideLoading();if(r.error===0){var s=r.url;i&&(s=e.formatUrl(s,"absolute")),t.afterUpload&&t.afterUpload.call(t,s,r,n),c?(e(".ke-dialog-row #remoteUrl",L).val(s),e(".ke-tabs-li",L)[0].click(),e(".ke-refresh-btn",L).click()):w.call(t,s,r.title,r.width,r.height,r.border,r.align)}else alert(r.message)},afterError:function(e){k.hideLoading(),t.errorDialog(e)}});F.fileBox.change(function(e){O.val(F.fileBox.val())}),s?M.click(function(n){t.loadPlugin("filemanager",function(){t.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(n,r){t.dialogs.length>1&&(e('[name="url"]',L).val(n),t.afterSelectFile&&t.afterSelectFile.call(t,n),t.hideDialog())}})})}):M.hide();var I=0,q=0;return P.click(function(t){var n=e('<img src="'+A.val()+'" />',document).css({position:"absolute",visibility:"hidden",top:0,left:"-1000px"});n.bind("load",function(){R(n.width(),n.height()),n.remove()}),e(document.body).append(n)}),_.change(function(e){I>0&&D.val(Math.round(q/I*parseInt(this.value,10)))}),D.change(function(e){q>0&&_.val(Math.round(I/q*parseInt(this.value,10)))}),A.val(r.imageUrl),R(r.imageWidth,r.imageHeight),H.val(r.imageTitle),B.each(function(){if(this.value===r.imageAlign)return this.checked=!0,!1}),g&&b===0&&(A[0].focus(),A[0].select()),k},t.plugin.image={edit:function(){var e=t.plugin.getSelectedImage();t.plugin.imageDialog({imageUrl:e?e.attr("data-ke-src"):"http://",imageWidth:e?e.width():"",imageHeight:e?e.height():"",imageTitle:e?e.attr("title"):"",imageAlign:e?e.attr("align"):"",showRemote:!0,showLocal:r,tabIndex:e?0:u,clickFn:function(e,n,r,i,s,o){t.exec("insertimage",e,n,r,i,s,o),setTimeout(function(){t.hideDialog().focus()},0)}})},"delete":function(){var e=t.plugin.getSelectedImage();e.parent().name=="a"&&(e=e.parent()),e.remove()}},t.clickToolbar(n,t.plugin.image.edit)});